{% extends 'base.html' %}
{% block content %}
        <h2>Welcome, {{ teacher.teacher_name }}</h2>

       

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Mark</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr data-id="{{ student.id }}" data-name="{{ student.name }}" data-subject="{{ student.subject }}" data-marks="{{ student.marks }}">
                    <td><div class="circle-blue">{{ student.name|first|upper }}</div>{{ student.name }}</td>
                    <td>{{ student.subject }}</td>
                    <td>{{ student.marks }}</td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" style="border-radius: 50%;" type="button" data-bs-toggle="dropdown">
                                
                            </button>
                            <ul class="dropdown-menu">
                                <li><button class="dropdown-item edit-btn">Edit</button></li>
                                <li><button class="dropdown-item delete-btn">Delete</button></li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
         <div class="d-flex justify-content-between align-items-center mb-3">
            
            <button id="addStudentBtn" class="btn btn-secondary">+ Add New Student</button>
        </div>
    </div>

    

    <!-- Add new student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div style="text-align: right;"><span class="close" id="closeModal">&times;</span></div>
            <h3>Add Student</h3>
            <form id="addStudentForm">
                {% csrf_token %}
                <label>Name</label>
            <div>
                <input type="text" class="form-control" name="name" placeholder="Student Name" required>
            </div>

            <label>Subject</label>
            <div>
                <input type="text" class="form-control" name="subject" placeholder="Subject" required>
            </div>

            <label>Mark</label>
            <div>
                <input type="number" class="form-control" name="marks" placeholder="Mark" min="0" max="100" required>
            </div>

            <div style="text-align: center;"><button type="submit" class="btn btn-dark w-100 mt-3" style="width:50% !important">Add</button></div>
            <p id="addError" style="color:red;"></p>
            </form>
        </div>
    </div>

    <!-- Edit student Modal -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div><span class="close" id="closeEditModal">&times;</span></div>
            <h3>Edit Marks</h3>
            <form id="editStudentForm">
                {% csrf_token %}
                <input type="hidden" name="student_id" id="edit-student-id">
                <p><strong id="edit-name-subject"></strong></p>
                <label for="edit-marks">Marks:</label>
                <input type="number" id="edit-marks" name="marks" min="0" max="100" required>
                <br><br>
                <button type="submit" class="btn btn-secondary">Update</button>
                <p id="editError" style="color:red;"></p>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS for dropdown -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Student Portal Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const getCSRFToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

            // === Add Student Modal Logic ===
            const addModal = document.getElementById('addStudentModal');
            const addBtn = document.getElementById('addStudentBtn');
            const closeAddModal = document.getElementById('closeModal');
            const addForm = document.getElementById('addStudentForm');
            const addError = document.getElementById('addError');

            addBtn.onclick = () => addModal.style.display = 'block';
            closeAddModal.onclick = () => { addModal.style.display = 'none'; addForm.reset(); addError.textContent = ''; };
            window.onclick = event => { if (event.target === addModal) addModal.style.display = 'none'; };

            addForm.onsubmit = function (e) {
                e.preventDefault();
                const formData = new FormData(addForm);
                fetch("{% url 'add_student' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        addError.textContent = data.error || "Something went wrong.";
                    }
                })
                .catch(() => { addError.textContent = "Request failed."; });
            };

            // === Edit Modal Logic ===
            const editModal = document.getElementById('editStudentModal');
            const closeEdit = document.getElementById('closeEditModal');
            const editForm = document.getElementById('editStudentForm');
            const editNameSubject = document.getElementById('edit-name-subject');
            const editStudentId = document.getElementById('edit-student-id');
            const editMarks = document.getElementById('edit-marks');
            const editError = document.getElementById('editError');

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const row = this.closest('tr');
                    editStudentId.value = row.dataset.id;
                    editNameSubject.textContent = `${row.dataset.name} - ${row.dataset.subject}`;
                    editMarks.value = row.dataset.marks;
                    editModal.style.display = 'block';
                });
            });

            closeEdit.onclick = () => { editModal.style.display = 'none'; editForm.reset(); editError.textContent = ''; };
            window.onclick = event => { if (event.target === editModal) editModal.style.display = 'none'; };

            editForm.onsubmit = function (e) {
                e.preventDefault();
                const studentId = editStudentId.value;
                const newMarks = editMarks.value;

                fetch(`/edit/${studentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `marks=${newMarks}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        editError.textContent = data.error || "Failed to update.";
                    }
                });
            };

            // === Delete Student ===
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const row = this.closest('tr');
                    const studentId = row.dataset.id;
                    if (!confirm("Are you sure you want to delete this student?")) return;

                    fetch(`/delete/${studentId}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCSRFToken() }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert(data.error || "Delete failed.");
                        }
                    });
                });
            });
        });
    </script>

{% endblock %}
